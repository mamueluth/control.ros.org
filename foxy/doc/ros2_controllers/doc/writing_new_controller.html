

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Writing a new controller &mdash; ROS2_Control: Foxy Feb 2023 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/override.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon_ros-controls.ico"/>
  

  
  

  
    <link rel="canonical" href="https://control.ros.org/rolling//foxy/doc/ros2_controllers/doc/writing_new_controller.html" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="diff_drive_controller" href="../diff_drive_controller/doc/userdoc.html" />
    <link rel="prev" title="ros2_controllers" href="controllers_index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/logo_ros-controls.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/getting_started.html#architecture">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/getting_started.html#hardware-components">Hardware Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ros2_control/doc/index.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ros2_control/doc/index.html#core-functionalities">Core functionalities</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="controllers_index.html">ros2_controllers</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="controllers_index.html#nomenclature">Nomenclature</a></li>
<li class="toctree-l2"><a class="reference internal" href="controllers_index.html#id1">Controllers</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="controllers_index.html#guidelines-and-best-practices">Guidelines and Best Practices</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Writing a new controller</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#useful-external-references">Useful External References</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="controllers_index.html#available-controllers">Available Controllers</a></li>
<li class="toctree-l3"><a class="reference internal" href="controllers_index.html#available-broadcasters">Available Broadcasters</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../ros2_control/ros2controlcli/doc/userdoc.html">Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../differences_to_ros1/differences_to_ros1.html">Differences to ros_control (ROS1)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../differences_to_ros1/differences_to_ros1.html#migration-guide-to-ros2-control">Migration Guide to ros2_control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ros2_control_demos/doc/index.html">Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resources/resources.html">Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/contributing.html">Pull Requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/contributing.html#rules-for-the-repositories-and-process-of-merging-pull-requests">Rules for the repositories and process of merging pull requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/contributing.html#writing-documentation">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/contributing.html#repository-structure-and-ci-configuration">Repository structure and CI configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_ideas.html">Project Ideas for GSoC 2022</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../acknowledgements/acknowledgements.html">Acknowledgements</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ROS2_Control: Foxy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="controllers_index.html">ros2_controllers</a> &raquo;</li>
        
      <li>Writing a new controller</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/ros-controls/control.ros.org/blob/foxy//doc/ros2_controllers/doc/writing_new_controller.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="writing-a-new-controller">
<span id="writing-new-controllers"></span><h1>Writing a new controller<a class="headerlink" href="#writing-a-new-controller" title="Permalink to this heading">Â¶</a></h1>
<p>In this framework controllers are libraries, dynamically loaded by the controller manager using the <a class="reference external" href="ros.org/wiki/pluginlib">pluginlib</a> interface.
The following is a step-by-step guide to create source files, basic tests, and compile rules for a new controller.</p>
<ol class="arabic">
<li><p><strong>Preparing package</strong></p>
<p>If the package for the controller does not exist, then create it first.
The package should have <code class="docutils literal notranslate"><span class="pre">ament_cmake</span></code> as a build type.
The easiest way is to search online for the most recent manual.
A helpful command to support this process is <code class="docutils literal notranslate"><span class="pre">ros2</span> <span class="pre">pkg</span> <span class="pre">create</span></code>.
Use the <code class="docutils literal notranslate"><span class="pre">--help</span></code> flag for more information on how to use it.
There is also an option to create library source files and compile rules to help you in the following steps.</p>
</li>
<li><p><strong>Preparing source files</strong></p>
<p>After creating the package, you should have at least <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> and <code class="docutils literal notranslate"><span class="pre">package.xml</span></code> files in it.
Create also <code class="docutils literal notranslate"><span class="pre">include/&lt;PACKAGE_NAME&gt;/</span></code> and <code class="docutils literal notranslate"><span class="pre">src</span></code> folders if they do not already exist.
In <code class="docutils literal notranslate"><span class="pre">include/&lt;PACKAGE_NAME&gt;/</span></code> folder add <code class="docutils literal notranslate"><span class="pre">&lt;controller_name&gt;.hpp</span></code> and <code class="docutils literal notranslate"><span class="pre">&lt;controller_name&gt;.cpp</span></code> in the <code class="docutils literal notranslate"><span class="pre">src</span></code> folder.
Optionally add <code class="docutils literal notranslate"><span class="pre">visibility_control.h</span></code> with the definition of export rules for Windows.
You can copy this file from an existing controller package and change the name prefix to the <code class="docutils literal notranslate"><span class="pre">&lt;PACKAGE_NAME&gt;</span></code>.</p>
</li>
<li><p><strong>Adding declarations into header file (.hpp)</strong></p>
<ol class="arabic simple">
<li><p>Take care that you use header guards. ROS2-style is using <code class="docutils literal notranslate"><span class="pre">#ifndef</span></code> and <code class="docutils literal notranslate"><span class="pre">#define</span></code> preprocessor directives. (For more information on this, a search engine is your friend :) ).</p></li>
<li><p>include <code class="docutils literal notranslate"><span class="pre">&quot;controller_interface/controller_interface.hpp&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">visibility_control.h</span></code> if you are using one.</p></li>
<li><p>Define a unique namespace for your controller. This is usually a package name written in <code class="docutils literal notranslate"><span class="pre">snake_case</span></code>.</p></li>
<li><p>Define the class of the controller, extending <code class="docutils literal notranslate"><span class="pre">ControllerInterface</span></code>, e.g.,
.. code:: c++
class ControllerName : public controller_interface::ControllerInterface</p></li>
<li><p>Add a constructor without parameters and the following public methods overriding the <code class="docutils literal notranslate"><span class="pre">ControllerInterface</span></code> definition: <code class="docutils literal notranslate"><span class="pre">init</span></code>, <code class="docutils literal notranslate"><span class="pre">command_interface_configuration</span></code>, <code class="docutils literal notranslate"><span class="pre">state_interface_configuration</span></code>, <code class="docutils literal notranslate"><span class="pre">on_configure</span></code>, <code class="docutils literal notranslate"><span class="pre">on_activate</span></code>, <code class="docutils literal notranslate"><span class="pre">on_deactivate</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code>.
For exact definitions check the <code class="docutils literal notranslate"><span class="pre">controller_interface/controller_interface.hpp</span></code> header or one of the controllers from <a class="reference external" href="https://github.com/ros-controls/ros2_controllers">ros2_controllers</a>.</p></li>
<li><p>(optional) Often, controllers accept lists of joint names and interface names as parameters.
If so, you can add two protected string vectors to store those values.</p></li>
</ol>
</li>
<li><p><strong>Adding definitions into source file (.cpp)</strong></p>
<ol class="arabic simple">
<li><p>Include the header file of your controller and add a namespace definition to simplify further development.</p></li>
<li><p>(optional) Implement a constructor if needed. There, you could initialize member variables.
This could also be done in the <code class="docutils literal notranslate"><span class="pre">init</span></code> method.</p></li>
<li><p>Implement the <code class="docutils literal notranslate"><span class="pre">init</span></code> method. The first line usually calls the parent <code class="docutils literal notranslate"><span class="pre">init</span></code> method.
Here is the best place to initialize the variables, reserve memory, and most importantly, declare node parameters used by the controller. If everything works fine return <code class="docutils literal notranslate"><span class="pre">controller_interface::return_type::OK</span></code> or <code class="docutils literal notranslate"><span class="pre">controller_interface::return_type::ERROR</span></code> otherwise.</p></li>
<li><p>Write the <code class="docutils literal notranslate"><span class="pre">on_configure</span></code> method. Parameters are usually read here, and everything is prepared so that the controller can be started.</p></li>
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">command_interface_configuration</span></code> and <code class="docutils literal notranslate"><span class="pre">state_interface_configuration</span></code> where required interfaces are defined.
There are three options of the interface configuration <code class="docutils literal notranslate"><span class="pre">ALL</span></code>, <code class="docutils literal notranslate"><span class="pre">INDIVIDUAL</span></code>, and <code class="docutils literal notranslate"><span class="pre">NONE</span></code> defined in <code class="docutils literal notranslate"><span class="pre">controller_interface/controller_interface.hpp&quot;</span></code>.
<code class="docutils literal notranslate"><span class="pre">ALL</span></code> and <code class="docutils literal notranslate"><span class="pre">NONE</span></code> option will ask for access to all available interfaces or none of them. The <code class="docutils literal notranslate"><span class="pre">INDIVIDUAL</span></code> configuration needs a detailed list of required interface names. Those are usually provided as parameters.
The full interface names have structure <code class="docutils literal notranslate"><span class="pre">&lt;joint_name&gt;/&lt;interface_type&gt;</span></code>.</p></li>
<li><p>Implement the <code class="docutils literal notranslate"><span class="pre">on_activate</span></code> method with checking, and potentially sorting, the interfaces and assigning membersâ initial values.
This method is part of the real-time loop, therefore avoid any reservation of memory and, in general, keep it as short as possible.</p></li>
<li><p>Implement the <code class="docutils literal notranslate"><span class="pre">on_deactivate</span></code> method, which does the opposite of <code class="docutils literal notranslate"><span class="pre">on_activate</span></code>.
In many cases, this method is empty.
This method should also be real-time safe as much as possible.</p></li>
<li><p>Implement the <code class="docutils literal notranslate"><span class="pre">update</span></code> method as the main entry point. The method should be implemented with <a class="reference external" href="https://en.wikipedia.org/wiki/Real-time_computing">real-time</a> constraints in mind.
When this method is called, the state interfaces have the most recent values from the hardware, and new commands for the hardware should be written into command interfaces.</p></li>
<li><p>IMPORTANT: At the end of your file after the namespace is closed, add the <code class="docutils literal notranslate"><span class="pre">PLUGINLIB_EXPORT_CLASS</span></code> macro.
For this you will need to include the <code class="docutils literal notranslate"><span class="pre">&quot;pluginlib/class_list_macros.hpp&quot;</span></code> header.
As first parameters you should provide exact controller class, e.g., <code class="docutils literal notranslate"><span class="pre">&lt;controller_name_namespace&gt;::&lt;ControllerName&gt;</span></code>, and as second the base class, i.e., <code class="docutils literal notranslate"><span class="pre">controller_interface::ControllerInterface</span></code>.</p></li>
</ol>
</li>
<li><p><strong>Writing export definition for pluginlib</strong></p>
<ol class="arabic simple">
<li><p>Create the <code class="docutils literal notranslate"><span class="pre">&lt;controller_name&gt;.xml</span></code> file in the package and add a definition of the library and controllerâs class which has to be visible for the pluginlib.
The easiest way to do that is to check other controllers in the <a class="reference external" href="https://github.com/ros-controls/ros2_controllers">ros2_controllers</a> package.</p></li>
<li><p>Usually, the plugin name is defined by the package (namespace) and the class name, e.g.,
<code class="docutils literal notranslate"><span class="pre">&lt;controller_name_package&gt;/&lt;ControllerName&gt;</span></code>.
This name defines the controllerâs type when the controller manager searches for it.
The other two files have to correspond to the definition done in macro at the bottom of the <code class="docutils literal notranslate"><span class="pre">&lt;controller_name&gt;.cpp</span></code> file.</p></li>
</ol>
</li>
<li><p><strong>Writing simple test to check if the controller can be found and loaded</strong></p>
<ol class="arabic simple">
<li><p>Create the folder <code class="docutils literal notranslate"><span class="pre">test</span></code> in your package, if it does not exist already, and add a file named <code class="docutils literal notranslate"><span class="pre">test_load_&lt;controller_name&gt;.cpp</span></code>.</p></li>
<li><p>You can safely copy the fileâs content for any controller defined in the <a class="reference external" href="https://github.com/ros-controls/ros2_controllers">ros2_controllers</a> package.</p></li>
<li><p>Change the name of the copied test and in the last line, where controller type is specified put the name defined in <code class="docutils literal notranslate"><span class="pre">&lt;controller_name&gt;.xml</span></code> file, e.g., <code class="docutils literal notranslate"><span class="pre">&lt;controller_name_package&gt;/&lt;ControllerName&gt;</span></code>.</p></li>
</ol>
</li>
<li><p><strong>Add compile directives into ``CMakeLists.txt`` file</strong></p>
<ol class="arabic">
<li><p>Under the line <code class="docutils literal notranslate"><span class="pre">find_package(ament_cmake</span> <span class="pre">REQUIRED)</span></code> add further dependencies.
Those are at least: <code class="docutils literal notranslate"><span class="pre">controller_interface</span></code>, <code class="docutils literal notranslate"><span class="pre">hardware_interface</span></code>, <code class="docutils literal notranslate"><span class="pre">pluginlib</span></code>, <code class="docutils literal notranslate"><span class="pre">rclcpp</span></code> and <code class="docutils literal notranslate"><span class="pre">rclcpp_lifecycle</span></code>.</p></li>
<li><p>Add a compile directive for a shared library providing the <code class="docutils literal notranslate"><span class="pre">&lt;controller_name&gt;.cpp</span></code> file as the source.</p></li>
<li><p>Add targeted include directories for the library. This is usually only <code class="docutils literal notranslate"><span class="pre">include</span></code>.</p></li>
<li><p>Add ament dependencies needed by the library. You should add at least those listed under 1.</p></li>
<li><p>Export for pluginlib description file using the following command:
.. code:: cmake</p>
<blockquote>
<div><p>pluginlib_export_plugin_description_file(controller_interface &lt;controller_name&gt;.xml)</p>
</div></blockquote>
</li>
<li><p>Add install directives for targets and include directory.</p></li>
<li><p>In the test section add the following dependencies: <code class="docutils literal notranslate"><span class="pre">ament_cmake_gmock</span></code>, <code class="docutils literal notranslate"><span class="pre">controller_manager</span></code>, <code class="docutils literal notranslate"><span class="pre">hardware_interface</span></code>, <code class="docutils literal notranslate"><span class="pre">ros2_control_test_assets</span></code>.</p></li>
<li><p>Add compile definitions for the tests using the <code class="docutils literal notranslate"><span class="pre">ament_add_gmock</span></code> directive.
For details, see how it is done for controllers in the <a class="reference external" href="https://github.com/ros-controls/ros2_controllers">ros2_controllers</a> package.</p></li>
<li><p>(optional) Add your controller`s library into <code class="docutils literal notranslate"><span class="pre">ament_export_libraries</span></code> before <code class="docutils literal notranslate"><span class="pre">ament_package()</span></code>.</p></li>
</ol>
</li>
<li><p><strong>Add dependencies into ``package.xml`` file</strong></p>
<ol class="arabic simple">
<li><p>Add at least the following packages into <code class="docutils literal notranslate"><span class="pre">&lt;depend&gt;</span></code> tag: <code class="docutils literal notranslate"><span class="pre">controller_interface</span></code>, <code class="docutils literal notranslate"><span class="pre">hardware_interface</span></code>, <code class="docutils literal notranslate"><span class="pre">pluginlib</span></code>, <code class="docutils literal notranslate"><span class="pre">rclcpp</span></code> and <code class="docutils literal notranslate"><span class="pre">rclcpp_lifecycle</span></code>.</p></li>
<li><p>Add at least the following package into <code class="docutils literal notranslate"><span class="pre">&lt;test_depend&gt;</span></code> tag: <code class="docutils literal notranslate"><span class="pre">ament_add_gmock</span></code>, <code class="docutils literal notranslate"><span class="pre">controller_manager</span></code>, <code class="docutils literal notranslate"><span class="pre">hardware_interface</span></code>, and <code class="docutils literal notranslate"><span class="pre">ros2_control_test_assets</span></code>.</p></li>
</ol>
</li>
<li><p><strong>Compiling and testing the controller</strong></p>
<ol class="arabic simple">
<li><p>Now everything is ready to compile the controller using the <code class="docutils literal notranslate"><span class="pre">colcon</span> <span class="pre">build</span> <span class="pre">&lt;controller_name_package&gt;</span></code> command.
Remember to go into the root of your workspace before executing this command.</p></li>
<li><p>If compilation was successful, source the <code class="docutils literal notranslate"><span class="pre">setup.bash</span></code> file from the install folder and execute <code class="docutils literal notranslate"><span class="pre">colcon</span> <span class="pre">test</span> <span class="pre">&lt;controller_name_package&gt;</span></code> to check if the new controller can be found through <code class="docutils literal notranslate"><span class="pre">pluginlib</span></code> library and be loaded by the controller manager.</p></li>
</ol>
</li>
</ol>
<p>Thatâs it! Enjoy writing great controllers!</p>
<section id="useful-external-references">
<h2>Useful External References<a class="headerlink" href="#useful-external-references" title="Permalink to this heading">Â¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://stoglrobotics.github.io/ros_team_workspace/use-cases/ros2_control/setup_controller.html">Templates and scripts for generating controllers shell</a></p></li>
</ul>
</section>
</section>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../diff_drive_controller/doc/userdoc.html" class="btn btn-neutral float-right" title="diff_drive_controller" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="controllers_index.html" class="btn btn-neutral float-left" title="ros2_controllers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2023, ros2_control Maintainers.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: foxy
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>ros2_control - Rolling</dt>
      <dd><a href="../../../../master/doc/ros2_controllers/doc/writing_new_controller.html">Master (latest)</a></dd>
    </dl>
    <dl>
      <dt>ros2_control - Foxy and Galactic</dt>
        <dd><a href="../../../../galactic/doc/ros2_controllers/doc/writing_new_controller.html">Galactic (recommended)</a></dd><br>
        <dd><a href="writing_new_controller.html">Foxy</a></dd><br>
    </dl>
  </div>
</div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>