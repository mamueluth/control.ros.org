

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Example 7: Full tutorial with a 6DOF robot &mdash; ROS2_Control: Rolling Aug 2023 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/override.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../../_static/favicon_ros-controls.ico"/>
  

  
  

  
    <link rel="canonical" href="https://control.ros.org/rolling//rolling/doc/ros2_control_demos/example_7/doc/userdoc.html" />

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/sphinx_highlight.js"></script>
        <script src="../../../../_static/clipboard.min.js"></script>
        <script src="../../../../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Example 8: Industrial Robots with an exposed transmission interface" href="../../example_8/doc/userdoc.html" />
    <link rel="prev" title="Example 6: Modular Robots with separate communication to each actuator" href="../../example_6/doc/userdoc.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html">
          

          
            
            <img src="../../../../_static/logo_ros-controls.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/getting_started.html#architecture">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/getting_started.html#hardware-components">Hardware Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ros2_control/doc/index.html">ros2_control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ros2_controllers/doc/controllers_index.html">ros2_controllers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ros2_control/ros2controlcli/doc/userdoc.html">Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../differences_to_ros1/differences_to_ros1.html">Differences to ros_control (ROS1)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../differences_to_ros1/differences_to_ros1.html#migration-guide-to-ros2-control">Migration Guide to ros2_control</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../doc/index.html">Demos</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../doc/index.html#what-you-can-find-in-this-repository">What you can find in this repository</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../doc/index.html#goals">Goals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../doc/index.html#examples-overview">Examples Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../doc/index.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../doc/index.html#quick-hints">Quick Hints</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../doc/index.html#examples">Examples</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../example_1/doc/userdoc.html">Example 1: RRBot</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../example_2/doc/userdoc.html">Example 2: DiffBot</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../example_3/doc/userdoc.html">Example 3: RRBot with multiple interfaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../example_4/doc/userdoc.html">Example 4: Industrial robot with integrated sensor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../example_5/doc/userdoc.html">Example 5: Industrial robots with externally connected sensor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../example_6/doc/userdoc.html">Example 6: Modular robots with separate communication to each actuator</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Example 7: Full tutorial with a 6DOF robot</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ros2-control-overview">ros2_control overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#writing-a-urdf">Writing a URDF</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#geometry">Geometry</a></li>
<li class="toctree-l5"><a class="reference internal" href="#urdf-file">URDF file</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#writing-a-hardware-interface">Writing a hardware interface</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#plugin-description-file">Plugin description file</a></li>
<li class="toctree-l5"><a class="reference internal" href="#cmake-library">CMake library</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#writing-a-controller">Writing a controller</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#id1">Plugin description file</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id2">CMake library</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#launching-the-example">Launching the example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../example_8/doc/userdoc.html">Example 8: Using transmissions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../example_9/doc/userdoc.html">Example 9: Gazebo classic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../example_12/doc/userdoc.html">Example 12: Controller chaining</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../supported_robots/supported_robots.html">Supported Robots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../resources/resources.html">Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/contributing.html">Pull Requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/contributing.html#rules-for-the-repositories-and-process-of-merging-pull-requests">Rules for the repositories and process of merging pull requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/contributing.html#writing-documentation">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/contributing.html#repository-structure-and-ci-configuration">Repository structure and CI configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../project_ideas.html">Project Ideas for GSoC 2022</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../acknowledgements/acknowledgements.html">Acknowledgements</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">ROS2_Control: Rolling</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          



















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../doc/index.html">Demos</a> &raquo;</li>
        
      <li>Example 7: Full tutorial with a 6DOF robot</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <!-- User defined GitHub URL -->
              <a href="https://github.com/ros-controls/ros2_control_demos/blob/master/example_7/doc/userdoc.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="example-7-full-tutorial-with-a-6dof-robot">
<span id="ros2-control-demos-example-7-userdoc"></span><h1>Example 7: Full tutorial with a 6DOF robot<a class="headerlink" href="#example-7-full-tutorial-with-a-6dof-robot" title="Permalink to this heading"></a></h1>
<p>ros2_control is a realtime control framework designed for general robotics applications. Standard c++ interfaces exist for interacting with hardware and querying user defined controller commands. These interfaces enhance code modularity and robot agnostic design. Application specific details, e.g. what controller to use, how many joints a robot has and their kinematic structure, are specified via YAML parameter configuration files and a Universal Robot Description File (URDF). Finally, the ros2_control framework is deployed via ROS 2 launch a file.</p>
<p>This tutorial will address each component of ros2_control in detail, namely:</p>
<ol class="arabic simple">
<li><p>ros2_control overview</p></li>
<li><p>Writing a URDF</p></li>
<li><p>Writing a hardware interface</p></li>
<li><p>Writing a controller</p></li>
</ol>
<section id="ros2-control-overview">
<h2>ros2_control overview<a class="headerlink" href="#ros2-control-overview" title="Permalink to this heading"></a></h2>
<p>ros2_control introduces <code class="docutils literal notranslate"><span class="pre">state_interfaces</span></code> and <code class="docutils literal notranslate"><span class="pre">command_interfaces</span></code> to abstract hardware interfacing. The <code class="docutils literal notranslate"><span class="pre">state_interfaces</span></code> are read only data handles that generally represent sensors readings, e.g. joint encoder. The <code class="docutils literal notranslate"><span class="pre">command_interfaces</span></code> are read and write data handles that hardware commands, like setting a joint velocity reference. The <code class="docutils literal notranslate"><span class="pre">command_interfaces</span></code> are exclusively accessed, meaning if a controller has “claimed” an interface, it cannot be used by any other controller until it is released. Both interface types are uniquely designated with a name and type. The names and types for all available state and command interfaces are specified in a YAML configuration file and a URDF file.</p>
<p>ros2_control provides the <code class="docutils literal notranslate"><span class="pre">ControllerInterface</span></code> and <code class="docutils literal notranslate"><span class="pre">HardwareInterface</span></code> classes for robot agnostic control. During initialization, controllers request <code class="docutils literal notranslate"><span class="pre">state_interfaces</span></code> and <code class="docutils literal notranslate"><span class="pre">command_interfaces</span></code> required for operation through the <code class="docutils literal notranslate"><span class="pre">ControllerInterface</span></code>. On the other hand, hardware drivers offer <code class="docutils literal notranslate"><span class="pre">state_interfaces</span></code> and <code class="docutils literal notranslate"><span class="pre">command_interfaces</span></code> via the <code class="docutils literal notranslate"><span class="pre">HardwareInterface</span></code>. ros2_control ensure all requested interfaces are available before starting the controllers. The interface pattern allows vendors to write hardware specific drivers that are loaded at runtime.</p>
<p>The main program is a realtime read, update, write loop. During the  read call, hardware drivers that conform to <code class="docutils literal notranslate"><span class="pre">HardwareInterface</span></code> update their offered <code class="docutils literal notranslate"><span class="pre">state_interfaces</span></code> with the newest values received from the hardware. During the update call, controllers calculate commands from the updated <code class="docutils literal notranslate"><span class="pre">state_interfaces</span></code> and writes them into its <code class="docutils literal notranslate"><span class="pre">command_interfaces</span></code>. Finally, during to write call, the hardware drivers read values from their offer <code class="docutils literal notranslate"><span class="pre">command_interfaces</span></code> and send them to the hardware. The <code class="docutils literal notranslate"><span class="pre">ros2_control</span></code> node runs the main loop a realtime thread. The <code class="docutils literal notranslate"><span class="pre">ros2_control</span></code> node runs a second non-realtime thread to interact with ROS publishers, subscribers, and services.</p>
</section>
<section id="writing-a-urdf">
<h2>Writing a URDF<a class="headerlink" href="#writing-a-urdf" title="Permalink to this heading"></a></h2>
<p>The URDF file is a standard XML based file used to describe characteristic of a robot. It can represent any robot with a tree structure, except those with cycles. Each link must have only one parent. For ros2_control, there are three primary tags: <code class="docutils literal notranslate"><span class="pre">link</span></code>, <code class="docutils literal notranslate"><span class="pre">joint</span></code>, and <code class="docutils literal notranslate"><span class="pre">ros2_control</span></code>. The <code class="docutils literal notranslate"><span class="pre">joint</span></code> tag define the robot’s kinematic structure, while the <code class="docutils literal notranslate"><span class="pre">link</span></code> tag defines the dynamic properties and 3D geometry. The <code class="docutils literal notranslate"><span class="pre">ros2_control</span></code> defines the hardware and controller configuration.</p>
<section id="geometry">
<h3>Geometry<a class="headerlink" href="#geometry" title="Permalink to this heading"></a></h3>
<p>Most commercial robots already have <code class="docutils literal notranslate"><span class="pre">robot_description</span></code> packages defined, see the <a class="reference external" href="https://github.com/UniversalRobots/Universal_Robots_ROS2_Description">Universal Robots</a> for an example. However, this tutorial will go through the details of creating one from scratch.</p>
<p>First, we need a 3D model of our robot. For illustration, a generic 6 DOF robot manipulator will be used.</p>
<figure class="align-center" id="id3">
<a class="reference internal image-reference" href="../../../../_images/robot.png"><img alt="r6bot" src="../../../../_images/robot.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text">a generic 6 DOF robot manipulator</span><a class="headerlink" href="#id3" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>The robot’s 6 links each need to be processed and exported to their own <code class="docutils literal notranslate"><span class="pre">.stl</span></code> and <code class="docutils literal notranslate"><span class="pre">.dae</span></code> files. Generally, the <code class="docutils literal notranslate"><span class="pre">.stl</span></code> 3D model files are coarse meshes used for fast collision checking, while the <code class="docutils literal notranslate"><span class="pre">.dae</span></code> files are used for visualization purposed only. We will use the same mesh in our case for simplicity.</p>
<p>By convention, each <code class="docutils literal notranslate"><span class="pre">.stl</span></code> file expresses the position its vertices in its own reference frame. Hence, we need to specify the linear transformation (rotation and translation) between each link to define the robot’s full geometry. The 3D model for each link should be adjusted such that the proximal joint axis (the axis that connects the link to its parent) is in the z-axis direction. The 3D model’s origin should also be adjusted such that the bottom face of the mesh is co-planer with the xy-plane. The following mesh illustrates this configuration.</p>
<figure class="align-center" id="id4">
<a class="reference internal image-reference" href="../../../../_images/link_1.png"><img alt="link_1" src="../../../../_images/link_1.png" style="width: 400px;" /></a>
<figcaption>
<p><span class="caption-text">Link 1</span><a class="headerlink" href="#id4" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id5">
<a class="reference internal image-reference" href="../../../../_images/link_2_aligned.png"><img alt="link_2_aligned" src="../../../../_images/link_2_aligned.png" style="width: 400px;" /></a>
<figcaption>
<p><span class="caption-text">Link 2 aligned</span><a class="headerlink" href="#id5" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>Each mesh should be exported to its own file after processing them. <a class="reference external" href="https://www.blender.org/">Blender</a> is an open source 3D modeling software, which can import/export <code class="docutils literal notranslate"><span class="pre">.stl</span></code> and <code class="docutils literal notranslate"><span class="pre">.dae</span></code> files and manipulate their vertices. Blender was used to process the robot model in this tutorial.</p>
<p>We can finally calculate the transforms between the robot’s joints and begin writing the URDF. First, apply a negative 90 degree roll to link 2 in its frame.</p>
<figure class="align-center" id="id6">
<a class="reference internal image-reference" href="../../../../_images/link_2_roll.png"><img alt="link_2_roll" src="../../../../_images/link_2_roll.png" style="width: 400px;" /></a>
<figcaption>
<p><span class="caption-text">Link 2 with -90 degree roll</span><a class="headerlink" href="#id6" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>To keep the example simple, we will not apply a pitch now. Then, we apply a positive 90 degree yaw.</p>
<figure class="align-center" id="id7">
<a class="reference internal image-reference" href="../../../../_images/link_2_roll_yaw.png"><img alt="link_2_roll_yaw" src="../../../../_images/link_2_roll_yaw.png" style="width: 400px;" /></a>
<figcaption>
<p><span class="caption-text">Link 2 with -90 degree roll and 90 degree yaw</span><a class="headerlink" href="#id7" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>Finally, we apply a translation of -0.1 meters in the x-axis and 0.18 meters in the z-axis between the link 2 and link 1 frame. The final result is shown below.</p>
<figure class="align-center" id="id8">
<a class="reference internal image-reference" href="../../../../_images/link_2_roll_yaw_trans.png"><img alt="link_2_roll_yaw_trans" src="../../../../_images/link_2_roll_yaw_trans.png" style="width: 400px;" /></a>
<figcaption>
<p><span class="caption-text">Link 2 with -90 degree roll, 90 degree yaw, and translation</span><a class="headerlink" href="#id8" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>The described process is then repeated for all links.</p>
</section>
<section id="urdf-file">
<h3>URDF file<a class="headerlink" href="#urdf-file" title="Permalink to this heading"></a></h3>
<p>The URDF file is generally formatted according to the following template.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;robot</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;robot_6_dof&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="cm">&lt;!-- create link fixed to the &quot;world&quot; --&gt;</span>
<span class="w">  </span><span class="nt">&lt;link</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;base_link&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;visual&gt;</span>
<span class="w">      </span><span class="nt">&lt;origin</span><span class="w"> </span><span class="na">rpy=</span><span class="s">&quot;0 0 0&quot;</span><span class="w"> </span><span class="na">xyz=</span><span class="s">&quot;0 0 0&quot;</span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;geometry&gt;</span>
<span class="w">        </span><span class="nt">&lt;mesh</span><span class="w"> </span><span class="na">filename=</span><span class="s">&quot;package://robot_6_dof/meshes/visual/link_0.dae&quot;</span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;/geometry&gt;</span>
<span class="w">    </span><span class="nt">&lt;/visual&gt;</span>
<span class="w">    </span><span class="nt">&lt;collision&gt;</span>
<span class="w">      </span><span class="nt">&lt;origin</span><span class="w"> </span><span class="na">rpy=</span><span class="s">&quot;0 0 0&quot;</span><span class="w"> </span><span class="na">xyz=</span><span class="s">&quot;0 0 0&quot;</span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;geometry&gt;</span>
<span class="w">        </span><span class="nt">&lt;mesh</span><span class="w"> </span><span class="na">filename=</span><span class="s">&quot;package://robot_6_dof/meshes/collision/link_0.stl&quot;</span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;/geometry&gt;</span>
<span class="w">    </span><span class="nt">&lt;/collision&gt;</span>
<span class="w">    </span><span class="nt">&lt;inertial&gt;</span>
<span class="w">      </span><span class="nt">&lt;mass</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;inertia</span><span class="w"> </span><span class="na">ixx=</span><span class="s">&quot;1.0&quot;</span><span class="w"> </span><span class="na">ixy=</span><span class="s">&quot;0.0&quot;</span><span class="w"> </span><span class="na">ixz=</span><span class="s">&quot;0.0&quot;</span><span class="w"> </span><span class="na">iyy=</span><span class="s">&quot;1.0&quot;</span><span class="w"> </span><span class="na">iyz=</span><span class="s">&quot;0.0&quot;</span><span class="w"> </span><span class="na">izz=</span><span class="s">&quot;1.0&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/inertial&gt;</span>
<span class="w">  </span><span class="nt">&lt;/link&gt;</span>
<span class="w">  </span><span class="cm">&lt;!-- additional links ... --&gt;</span>
<span class="w">  </span><span class="nt">&lt;link</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;world&quot;</span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;link</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;tool0&quot;</span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;joint</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;base_joint&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;fixed&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;parent</span><span class="w"> </span><span class="na">link=</span><span class="s">&quot;world&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;child</span><span class="w"> </span><span class="na">link=</span><span class="s">&quot;base_link&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;origin</span><span class="w"> </span><span class="na">rpy=</span><span class="s">&quot;0 0 0&quot;</span><span class="w"> </span><span class="na">xyz=</span><span class="s">&quot;0 0 0&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;axis</span><span class="w"> </span><span class="na">xyz=</span><span class="s">&quot;0 0 1&quot;</span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/joint&gt;</span>
<span class="w">  </span><span class="cm">&lt;!-- joints - main serial chain --&gt;</span>
<span class="w">  </span><span class="nt">&lt;joint</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;joint_1&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;revolute&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;parent</span><span class="w"> </span><span class="na">link=</span><span class="s">&quot;base_link&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;child</span><span class="w"> </span><span class="na">link=</span><span class="s">&quot;link_1&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;origin</span><span class="w"> </span><span class="na">rpy=</span><span class="s">&quot;0 0 0&quot;</span><span class="w"> </span><span class="na">xyz=</span><span class="s">&quot;0 0 0.061584&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;axis</span><span class="w"> </span><span class="na">xyz=</span><span class="s">&quot;0 0 1&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;limit</span><span class="w"> </span><span class="na">effort=</span><span class="s">&quot;1000.0&quot;</span><span class="w"> </span><span class="na">lower=</span><span class="s">&quot;-3.141592653589793&quot;</span><span class="w"> </span><span class="na">upper=</span><span class="s">&quot;3.141592653589793&quot;</span><span class="w"> </span><span class="na">velocity=</span><span class="s">&quot;2.5&quot;</span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/joint&gt;</span>
<span class="w">  </span><span class="cm">&lt;!-- additional joints ... --&gt;</span>
<span class="w">  </span><span class="cm">&lt;!-- ros2 control tag --&gt;</span>
<span class="w">  </span><span class="nt">&lt;ros2_control</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;robot_6_dof&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;system&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;hardware&gt;</span>
<span class="w">      </span><span class="nt">&lt;plugin&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- {Name_Space}/{Class_Name}--&gt;</span>
<span class="w">      </span><span class="nt">&lt;/plugin&gt;</span>
<span class="w">    </span><span class="nt">&lt;/hardware&gt;</span>
<span class="w">    </span><span class="nt">&lt;joint</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;joint_1&quot;</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;command_interface</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;position&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;param</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;min&quot;</span><span class="nt">&gt;</span>{-2*pi}<span class="nt">&lt;/param&gt;</span>
<span class="w">        </span><span class="nt">&lt;param</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;max&quot;</span><span class="nt">&gt;</span>{2*pi}<span class="nt">&lt;/param&gt;</span>
<span class="w">      </span><span class="nt">&lt;/command_interface&gt;</span>
<span class="w">      </span><span class="cm">&lt;!-- additional command interfaces ... --&gt;</span>
<span class="w">      </span><span class="nt">&lt;state_interface</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;position&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;param</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;initial_value&quot;</span><span class="nt">&gt;</span>0.0<span class="nt">&lt;/param&gt;</span>
<span class="w">      </span><span class="nt">&lt;/state_interface&gt;</span>
<span class="w">      </span><span class="cm">&lt;!-- additional state interfaces ... --&gt;</span>
<span class="w">    </span><span class="nt">&lt;/joint&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- additional joints ...--&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- additional hardware/sensors ...--&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ros2_control&gt;</span>
<span class="nt">&lt;/robot&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">robot</span></code> tag encloses all contents of the URDF file. It has a name attribute which must be specified.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">link</span></code> tag defines the robot’s geometry and inertia properties. It has a name attribute which will be referred to by the <code class="docutils literal notranslate"><span class="pre">joint</span></code> tags.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">visual</span></code> tag specifies the rotation and translation of the visual mesh. If the meshes were process as described previously, then the <code class="docutils literal notranslate"><span class="pre">origin</span></code> tag can be left at all zeros.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">geometry</span></code> and <code class="docutils literal notranslate"><span class="pre">mesh</span></code> tags specify the location of the 3D mesh file relative to a specified ROS 2 package.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">collision</span></code> tag is equivalent to the <code class="docutils literal notranslate"><span class="pre">visual</span></code> tag, except the specified mesh is used for collision checking in some applications.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">inertial</span></code> tag specifies mass and inertia for the link. The origin tag specifies the link’s center of mass. These values are used to calculate forward and inverse dynamics. Since our application does not use dynamics, uniform arbitrary values are used.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">&lt;!--</span> <span class="pre">additional</span> <span class="pre">links</span> <span class="pre">...</span> <span class="pre">--&gt;</span></code> comments indicates that many consecutive <code class="docutils literal notranslate"><span class="pre">link</span></code> tags will be defined, one for each link.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">&lt;link</span> <span class="pre">name=&quot;world&quot;/&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&lt;link</span> <span class="pre">name=&quot;tool0&quot;/&gt;</span></code> elements are not required. However, it is convention to set the link at the tip of the robot to  tool0 and to define the robot’s base link relative to a world frame.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">joint</span></code> tag specifies the kinematic structure of the robot. It has two required attributes: name and type. The type specifies the viable motion between the two connected links. The subsequent <code class="docutils literal notranslate"><span class="pre">parent</span></code> and <code class="docutils literal notranslate"><span class="pre">child</span></code> links specify which two links are joined by the joint.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">axis</span></code> tag species the joint’s degree of freedom. If the meshes were process as described previously, then the axis value is always <code class="docutils literal notranslate"><span class="pre">&quot;0</span> <span class="pre">0</span> <span class="pre">1&quot;</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">limits</span></code> tag specifies kinematic and dynamics limits for the joint.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">ros2_control</span></code> tag specifies hardware configuration of the  robot. More specifically, the available state and command interfaces. The tag has two required attributes: name and type. Additional elements, such as sensors, are also included in this tag.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">hardware</span></code> and <code class="docutils literal notranslate"><span class="pre">plugin</span></code> tags instruct the ros2_control framework to dynamically load a hardware driver conforming to <code class="docutils literal notranslate"><span class="pre">HardwareInterface</span></code> as a plugin. The plugin is specified as <code class="docutils literal notranslate"><span class="pre">&lt;{Name_Space}/{Class_Name}</span></code>.</p></li>
<li><p>Finally, the <code class="docutils literal notranslate"><span class="pre">joint</span></code> tag specifies the state and command interfaces that the loaded plugins will offer. The joint is specified with the name attribute. The <code class="docutils literal notranslate"><span class="pre">command_interface</span></code> and <code class="docutils literal notranslate"><span class="pre">state_interface</span></code> tags specify the interface type, usually position, velocity, acceleration, or effort.</p></li>
</ul>
<p>To simplify the URDF file, <code class="docutils literal notranslate"><span class="pre">xacro</span></code> is used to define macros, see <a class="reference external" href="https://docs.ros.org/en/rolling/Tutorials/Intermediate/URDF/Using-Xacro-to-Clean-Up-a-URDF-File.html">this tutorial</a>. The complete xacro file for the robot in this tutorial is available <a class="reference external" href="https://github.com/ros-controls/ros2_control_demos/tree/master/example_7/r6bot_description/urdf/r6bot.urdf.xacro">here</a>. To verify the kinematic chain, the tool <code class="docutils literal notranslate"><span class="pre">urdf_to_graphviz</span></code> can be used after the URDF is generated by <code class="docutils literal notranslate"><span class="pre">xacro</span></code>. Running</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>xacro<span class="w"> </span>description/urdf/r6bot.urdf.xacro<span class="w"> </span>&gt;<span class="w"> </span>r6bot.urdf
urdf_to_graphviz<span class="w"> </span>r6bot.urdf<span class="w"> </span>r6bot
</pre></div>
</div>
<p>generates <code class="docutils literal notranslate"><span class="pre">r6bot.pdf</span></code>, showing the kinematic chain of the robot.</p>
</section>
</section>
<section id="writing-a-hardware-interface">
<h2>Writing a hardware interface<a class="headerlink" href="#writing-a-hardware-interface" title="Permalink to this heading"></a></h2>
<p>In ros2_control, hardware system components are integrated via user defined driver plugins that conform to the <code class="docutils literal notranslate"><span class="pre">HardwareInterface</span></code> public interface. Hardware plugins specified in the URDF are dynamically loaded during initialization using the pluginlib interface. In order to run the <code class="docutils literal notranslate"><span class="pre">ros2_control_node</span></code>, a parameter named <code class="docutils literal notranslate"><span class="pre">robot_description</span></code> must be set. This normally done in the ros2_control launch file.</p>
<p>The following code blocks will explain the requirements for writing a new hardware interface.</p>
<p>The hardware plugin for the tutorial robot is a class called <code class="docutils literal notranslate"><span class="pre">RobotSystem</span></code> that inherits from  <code class="docutils literal notranslate"><span class="pre">hardware_interface::SystemInterface</span></code>. The <code class="docutils literal notranslate"><span class="pre">SystemInterface</span></code> is one of the offered hardware interfaces designed for a complete robot system. For example, The UR5 uses this interface. The <code class="docutils literal notranslate"><span class="pre">RobotSystem</span></code> must implement five public methods.</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">on_init</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">export_state_interfaces</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">export_command_interfaces</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">read</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">write</span></code></p></li>
</ol>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">CallbackReturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rclcpp_lifecycle</span><span class="o">::</span><span class="n">node_interfaces</span><span class="o">::</span><span class="n">LifecycleNodeInterface</span><span class="o">::</span><span class="n">CallbackReturn</span><span class="p">;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;hardware_interface/types/hardware_interface_return_values.hpp&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">HARDWARE_INTERFACE_PUBLIC</span><span class="w"> </span><span class="n">RobotSystem</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">hardware_interface</span><span class="o">::</span><span class="n">SystemInterface</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">CallbackReturn</span><span class="w"> </span><span class="n">on_init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">hardware_interface</span><span class="o">::</span><span class="n">HardwareInfo</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">hardware_interface</span><span class="o">::</span><span class="n">StateInterface</span><span class="o">&gt;</span><span class="w"> </span><span class="n">export_state_interfaces</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">hardware_interface</span><span class="o">::</span><span class="n">CommandInterface</span><span class="o">&gt;</span><span class="w"> </span><span class="n">export_command_interfaces</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="n">return_type</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Time</span><span class="w"> </span><span class="o">&amp;</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Duration</span><span class="w"> </span><span class="o">&amp;</span><span class="n">period</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="n">return_type</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Time</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="cm">/*time*/</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Duration</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="cm">/*period*/</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// private members</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">on_init</span></code> method is called once during ros2_control initialization if the <code class="docutils literal notranslate"><span class="pre">RobotSystem</span></code> was specified in the URDF. In this method, communication between the robot hardware needs to be setup and memory dynamic should be allocated. Since the tutorial robot is simulated, explicit will communication not be established. Instead, vectors will be initialized that represent the state all the hardware, e.g. a vector of doubles describing joint angles, etc.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">CallbackReturn</span><span class="w"> </span><span class="nf">RobotSystem::on_init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">hardware_interface</span><span class="o">::</span><span class="n">HardwareInfo</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hardware_interface</span><span class="o">::</span><span class="n">SystemInterface</span><span class="o">::</span><span class="n">on_init</span><span class="p">(</span><span class="n">info</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">CallbackReturn</span><span class="o">::</span><span class="n">SUCCESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">CallbackReturn</span><span class="o">::</span><span class="n">ERROR</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// setup communication with robot hardware</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">CallbackReturn</span><span class="o">::</span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Notably, the behavior of <code class="docutils literal notranslate"><span class="pre">on_init</span></code> is expected to vary depending on the URDF file. The <code class="docutils literal notranslate"><span class="pre">SystemInterface::on_init(info)</span></code> call fills out the <code class="docutils literal notranslate"><span class="pre">info</span></code> object with specifics from the URDF. For example, the <code class="docutils literal notranslate"><span class="pre">info</span></code> object has fields for joints, sensors, gpios, and more. Suppose the sensor field has a name value of <code class="docutils literal notranslate"><span class="pre">tcp_force_torque_sensor</span></code>. Then the <code class="docutils literal notranslate"><span class="pre">on_init</span></code> must try to establish communication with that sensor. If it fails, then an error value is returned.</p>
<p>Next, <code class="docutils literal notranslate"><span class="pre">export_state_interfaces</span></code> and <code class="docutils literal notranslate"><span class="pre">export_command_interfaces</span></code> methods are called in succession. The <code class="docutils literal notranslate"><span class="pre">export_state_interfaces</span></code> method returns a vector of <code class="docutils literal notranslate"><span class="pre">StateInterface</span></code>, describing the <code class="docutils literal notranslate"><span class="pre">state_interfaces</span></code> for each joint. The <code class="docutils literal notranslate"><span class="pre">StateInterface</span></code> objects are read only data handles. Their constructors require an interface nae, interface type, and a pointer to a double data value. For the <code class="docutils literal notranslate"><span class="pre">RobotSystem</span></code>, the data pointers reference class member variables. This way, the data can be access from every method.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">hardware_interface</span><span class="o">::</span><span class="n">StateInterface</span><span class="o">&gt;</span><span class="w"> </span><span class="n">RobotSystem</span><span class="o">::</span><span class="n">export_state_interfaces</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">hardware_interface</span><span class="o">::</span><span class="n">StateInterface</span><span class="o">&gt;</span><span class="w"> </span><span class="n">state_interfaces</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// add state interfaces to ``state_interfaces`` for each joint, e.g. `info_.joints[0].state_interfaces_`, `info_.joints[1].state_interfaces_`, `info_.joints[2].state_interfaces_` ...</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">state_interfaces</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">export_command_interfaces</span></code> method is nearly identical to the previous one. The difference is that a vector of <code class="docutils literal notranslate"><span class="pre">CommandInterface</span></code> is returned. The vector contains objects describing the <code class="docutils literal notranslate"><span class="pre">command_interfaces</span></code> for each joint.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">hardware_interface</span><span class="o">::</span><span class="n">CommandInterface</span><span class="o">&gt;</span><span class="w"> </span><span class="n">RobotSystem</span><span class="o">::</span><span class="n">export_command_interfaces</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">hardware_interface</span><span class="o">::</span><span class="n">CommandInterface</span><span class="o">&gt;</span><span class="w"> </span><span class="n">command_interfaces</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// add command interfaces to ``command_interfaces`` for each joint, e.g. `info_.joints[0].command_interfaces_`, `info_.joints[1].command_interfaces_`, `info_.joints[2].command_interfaces_` ...</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">command_interfaces</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">read</span></code> method is core method in the ros2_control loop. During the main loop, ros2_control loops over all hardware components and calls the <code class="docutils literal notranslate"><span class="pre">read</span></code> method. It is executed on the realtime thread, hence the method must obey by realtime constraints. The <code class="docutils literal notranslate"><span class="pre">read</span></code> method is responsible for updating the data values of the <code class="docutils literal notranslate"><span class="pre">state_interfaces</span></code>. Since the data value point to class member variables, those values can be filled with their corresponding sensor values, which will in turn update the values of each exported <code class="docutils literal notranslate"><span class="pre">StateInterface</span></code> object.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">return_type</span><span class="w"> </span><span class="nf">RobotSystem::read</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Time</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Duration</span><span class="w"> </span><span class="o">&amp;</span><span class="n">period</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// read hardware values for state interfaces, e.g joint encoders and sensor readings</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">return_type</span><span class="o">::</span><span class="n">OK</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">write</span></code> method is another core method in the ros2_control loop. It is called after <code class="docutils literal notranslate"><span class="pre">update</span></code> in the realtime loop. For this reason, it must also obey by realtime constraints. The <code class="docutils literal notranslate"><span class="pre">write</span></code> method is responsible for updating the data values of the <code class="docutils literal notranslate"><span class="pre">command_interfaces</span></code>. As opposed to <code class="docutils literal notranslate"><span class="pre">read</span></code>, <code class="docutils literal notranslate"><span class="pre">write</span></code> accesses data values pointer to by the exported <code class="docutils literal notranslate"><span class="pre">CommandInterface</span></code> objects sends them to the corresponding hardware. For example, if the hardware supports setting a joint velocity via TCP, then this method accesses data of the corresponding <code class="docutils literal notranslate"><span class="pre">command_interface</span></code> and sends a packet with the value.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">return_type</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Time</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Duration</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">period</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// send command interface values to hardware, e.g joint set joint velocity</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">return_type</span><span class="o">::</span><span class="n">OK</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Finally, all ros2_control plugins should have the following two lines of code at the end of the file.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;pluginlib/class_list_macros.hpp&quot;</span>

<span class="n">PLUGINLIB_EXPORT_CLASS</span><span class="p">(</span><span class="n">robot_6_dof_hardware</span><span class="o">::</span><span class="n">RobotSystem</span><span class="p">,</span><span class="w"> </span><span class="n">hardware_interface</span><span class="o">::</span><span class="n">SystemInterface</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">PLUGINLIB_EXPORT_CLASS</span></code> is a c++ macro creates a plugin library using <code class="docutils literal notranslate"><span class="pre">pluginlib</span></code>.</p>
<section id="plugin-description-file">
<h3>Plugin description file<a class="headerlink" href="#plugin-description-file" title="Permalink to this heading"></a></h3>
<p>The plugin description file is a required XML file that describes a plugin’s library name, class type, namespace, description, and interface type. This file allows the ROS 2 to automatically discover and load plugins. It is formatted as follows.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;library</span><span class="w"> </span><span class="na">path=</span><span class="s">&quot;{Library_Name}&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;class</span>
<span class="w">    </span><span class="na">name=</span><span class="s">&quot;{Namespace}/{Class_Name}&quot;</span>
<span class="w">    </span><span class="na">type=</span><span class="s">&quot;{Namespace}::{Class_Name}&quot;</span>
<span class="w">    </span><span class="na">base_class_type=</span><span class="s">&quot;hardware_interface::SystemInterface&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;description&gt;</span>
<span class="w">    </span>{Human<span class="w"> </span>readable<span class="w"> </span>description}
<span class="w">  </span><span class="nt">&lt;/description&gt;</span>
<span class="w">  </span><span class="nt">&lt;/class&gt;</span>
<span class="nt">&lt;/library&gt;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">path</span></code> attribute of the <code class="docutils literal notranslate"><span class="pre">library</span></code> tags refers to the cmake library name of the user defined hardware plugin. See <a class="reference external" href="https://github.com/ros-controls/ros2_control_demos/tree/master/example_7/hardware_driver/robot_6_dof_hardware_plugin_description.xml">here</a> for the complete XML file.</p>
</section>
<section id="cmake-library">
<h3>CMake library<a class="headerlink" href="#cmake-library" title="Permalink to this heading"></a></h3>
<p>The general CMake template to make a hardware plugin available in ros2_control is shown below. Notice that a library is created using the plugin source code just like any other  cmake library. In addition, an extra compile definition and cmake export macro (<code class="docutils literal notranslate"><span class="pre">pluginlib_export_plugin_description_file</span></code>) need to be added. See <a class="reference external" href="https://github.com/ros-controls/ros2_control_demos/tree/master/example_7/hardware_driver/CMakeLists.txt">here</a> for the complete <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">add_library</span><span class="p">(</span>
<span class="w">    </span><span class="s">robot_6_dof_hardware</span>
<span class="w">    </span><span class="s">SHARED</span>
<span class="w">    </span><span class="s">src/robot_hardware.cpp</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="writing-a-controller">
<h2>Writing a controller<a class="headerlink" href="#writing-a-controller" title="Permalink to this heading"></a></h2>
<p>In ros2_control, controllers are implemented as plugins that conforms to the <code class="docutils literal notranslate"><span class="pre">ControllerInterface</span></code> public interface. Similar to the hardware interfaces, the controller plugins to load are specified using ROS parameters. This is normally  achieved by passing a YAML parameter file to the <code class="docutils literal notranslate"><span class="pre">ros2_control_node</span></code>. Unlike hardware interfaces, controllers exists in a finite set of states:</p>
<ol class="arabic simple">
<li><p>Unconfigured</p></li>
<li><p>Inactive</p></li>
<li><p>Active</p></li>
<li><p>Finalized</p></li>
</ol>
<p>Certain interface methods are called during transitions between these states. During the main control loop, the controller is in the active state.</p>
<p>The following code blocks will explain the requirements for writing a new hardware interface.</p>
<p>The controller plugin for the tutorial robot is a class called <code class="docutils literal notranslate"><span class="pre">RobotController</span></code> that inherits from  <code class="docutils literal notranslate"><span class="pre">controller_interface::ControllerInterface</span></code>. The <code class="docutils literal notranslate"><span class="pre">RobotController</span></code> must implement nine public methods. The last six are <a class="reference external" href="https://design.ros2.org/articles/node_lifecycle.html">managed node</a>  transitions callbacks.</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">command_interface_configuration</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">state_interface_configuration</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">update</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">on_configure</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">on_activate</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">on_deactivate</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">on_cleanup</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">on_error</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">on_shutdown</span></code></p></li>
</ol>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">RobotController</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">controller_interface</span><span class="o">::</span><span class="n">ControllerInterface</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">controller_interface</span><span class="o">::</span><span class="n">InterfaceConfiguration</span><span class="w"> </span><span class="n">command_interface_configuration</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="n">controller_interface</span><span class="o">::</span><span class="n">InterfaceConfiguration</span><span class="w"> </span><span class="nf">state_interface_configuration</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="n">controller_interface</span><span class="o">::</span><span class="n">return_type</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Time</span><span class="w"> </span><span class="o">&amp;</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Duration</span><span class="w"> </span><span class="o">&amp;</span><span class="n">period</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="n">controller_interface</span><span class="o">::</span><span class="n">CallbackReturn</span><span class="w"> </span><span class="nf">on_init</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="n">controller_interface</span><span class="o">::</span><span class="n">CallbackReturn</span><span class="w"> </span><span class="nf">on_configure</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp_lifecycle</span><span class="o">::</span><span class="n">State</span><span class="w"> </span><span class="o">&amp;</span><span class="n">previous_state</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="n">controller_interface</span><span class="o">::</span><span class="n">CallbackReturn</span><span class="w"> </span><span class="nf">on_activate</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp_lifecycle</span><span class="o">::</span><span class="n">State</span><span class="w"> </span><span class="o">&amp;</span><span class="n">previous_state</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="n">controller_interface</span><span class="o">::</span><span class="n">CallbackReturn</span><span class="w"> </span><span class="nf">on_deactivate</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp_lifecycle</span><span class="o">::</span><span class="n">State</span><span class="w"> </span><span class="o">&amp;</span><span class="n">previous_state</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="n">controller_interface</span><span class="o">::</span><span class="n">CallbackReturn</span><span class="w"> </span><span class="nf">on_cleanup</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp_lifecycle</span><span class="o">::</span><span class="n">State</span><span class="w"> </span><span class="o">&amp;</span><span class="n">previous_state</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="n">controller_interface</span><span class="o">::</span><span class="n">CallbackReturn</span><span class="w"> </span><span class="nf">on_error</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp_lifecycle</span><span class="o">::</span><span class="n">State</span><span class="w"> </span><span class="o">&amp;</span><span class="n">previous_state</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="n">controller_interface</span><span class="o">::</span><span class="n">CallbackReturn</span><span class="w"> </span><span class="nf">on_shutdown</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp_lifecycle</span><span class="o">::</span><span class="n">State</span><span class="w"> </span><span class="o">&amp;</span><span class="n">previous_state</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="c1">// private members</span>
<span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">on_init</span></code> method is called immediately after the controller plugin is dynamically loaded. The method is called only once during the lifetime for the controller, hence memory that exists for the lifetime of the controller should be allocated. Additionally, the parameter values for <code class="docutils literal notranslate"><span class="pre">joints</span></code>, <code class="docutils literal notranslate"><span class="pre">command_interfaces</span></code> and <code class="docutils literal notranslate"><span class="pre">state_interfaces</span></code> should be declared and accessed. Those parameter values are required for the next two methods.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">CallbackReturn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rclcpp_lifecycle</span><span class="o">::</span><span class="n">node_interfaces</span><span class="o">::</span><span class="n">LifecycleNodeInterface</span><span class="o">::</span><span class="n">CallbackReturn</span><span class="p">;[]()</span>

<span class="n">controller_interface</span><span class="o">::</span><span class="n">CallbackReturn</span><span class="w"> </span><span class="n">on_init</span><span class="p">(){</span>
<span class="w">    </span><span class="c1">// declare and get parameters needed for controller initialization</span>
<span class="w">    </span><span class="c1">// allocate memory that will exist for the life of the controller</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">CallbackReturn</span><span class="o">::</span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">on_configure</span></code> method is called immediately after the controller is set to the inactive state. This state occurs when the controller is started for the first time, but also when it is restarted. Reconfigurable parameters should be read in this method. Additionally, publishers and subscribers should be created.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">controller_interface</span><span class="o">::</span><span class="n">CallbackReturn</span><span class="w"> </span><span class="nf">on_configure</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp_lifecycle</span><span class="o">::</span><span class="n">State</span><span class="w"> </span><span class="o">&amp;</span><span class="n">previous_state</span><span class="p">){</span>
<span class="w">    </span><span class="c1">// declare and get parameters needed for controller operations</span>
<span class="w">    </span><span class="c1">// setup realtime buffers, ROS publishers, and ROS subscribers</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">CallbackReturn</span><span class="o">::</span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">command_interface_configuration</span></code>  method is called after <code class="docutils literal notranslate"><span class="pre">on_configure</span></code>. The method returns a list of <code class="docutils literal notranslate"><span class="pre">InterfaceConfiguration</span></code> objects to indicate which command interfaces the controller needs to operate. The command interfaces are uniquely identified by their name and interface type. If a requested interface is not offered by a loaded hardware interface, then the controller will fail.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">controller_interface</span><span class="o">::</span><span class="n">InterfaceConfiguration</span><span class="w"> </span><span class="nf">command_interface_configuration</span><span class="p">(){</span>
<span class="w">    </span><span class="n">controller_interface</span><span class="o">::</span><span class="n">InterfaceConfiguration</span><span class="w"> </span><span class="n">conf</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// add required command interface to `conf` by specifying their names and interface types.</span>
<span class="w">    </span><span class="c1">// ..</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">conf</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">state_interface_configuration</span></code> method is then called, which is similar to the last method. The difference is that  a list of <code class="docutils literal notranslate"><span class="pre">InterfaceConfiguration</span></code> objects representing the required state interfaces to operate is returned.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">controller_interface</span><span class="o">::</span><span class="n">InterfaceConfiguration</span><span class="w"> </span><span class="nf">state_interface_configuration</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">controller_interface</span><span class="o">::</span><span class="n">InterfaceConfiguration</span><span class="w"> </span><span class="n">conf</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// add required state interface to `conf` by specifying their names and interface types.</span>
<span class="w">    </span><span class="c1">// ..</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">conf</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">on_activate</span></code> is called once when the controller is activated. This method should handle controller restarts, such as setting the resetting reference to safe values. It should also perform controller specific safety checks. The <code class="docutils literal notranslate"><span class="pre">command_interface_configuration</span></code> and <code class="docutils literal notranslate"><span class="pre">state_interface_configuration</span></code> methods are also called again when the controller is activated.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">controller_interface</span><span class="o">::</span><span class="n">CallbackReturn</span><span class="w"> </span><span class="nf">on_activate</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp_lifecycle</span><span class="o">::</span><span class="n">State</span><span class="w"> </span><span class="o">&amp;</span><span class="n">previous_state</span><span class="p">){</span>
<span class="w">  </span><span class="c1">// Handle controller restarts and dynamic parameter updating</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">CallbackReturn</span><span class="o">::</span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">update</span></code> method is part of the main control loop. Since the method is part of the realtime control loop, the realtime constraint must be enforced. The controller should read from its state interfaces, read its reference and calculate a control output. Normally, the reference is accessed via a ROS 2 subscriber. Since the subscriber runs on the non-realtime thread, a realtime buffer is used to a transfer the message to the realtime thread. The realtime buffer is eventually a pointer to a ROS message with a mutex that guarantees thread safety and that the realtime thread is never blocked. The calculated control output should then be written to the command interface, which will in turn control the hardware.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">controller_interface</span><span class="o">::</span><span class="n">return_type</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Time</span><span class="w"> </span><span class="o">&amp;</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Duration</span><span class="w"> </span><span class="o">&amp;</span><span class="n">period</span><span class="p">){</span>
<span class="w">  </span><span class="c1">// Read controller inputs values from state interfaces</span>
<span class="w">  </span><span class="c1">// Calculate controller output values and write them to command interfaces</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">controller_interface</span><span class="o">::</span><span class="n">return_type</span><span class="o">::</span><span class="n">OK</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">on_deactivate</span></code> is called when a controller stops running. It is important to release the claimed command interface in this method, so other controllers can use them if needed. This is down with the <code class="docutils literal notranslate"><span class="pre">release_interfaces</span></code> function.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">controller_interface</span><span class="o">::</span><span class="n">CallbackReturn</span><span class="w"> </span><span class="nf">on_deactivate</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp_lifecycle</span><span class="o">::</span><span class="n">State</span><span class="w"> </span><span class="o">&amp;</span><span class="n">previous_state</span><span class="p">){</span>
<span class="w">    </span><span class="n">release_interfaces</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// The controller should be properly shutdown during this</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">CallbackReturn</span><span class="o">::</span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">on_cleanup</span></code> and <code class="docutils literal notranslate"><span class="pre">on_shutdown</span></code> are called when the controller’s lifecycle node is transitioning to shutting down. Freeing any allocated memory and general cleanup should be done in these methods.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">controller_interface</span><span class="o">::</span><span class="n">CallbackReturn</span><span class="w"> </span><span class="nf">on_cleanup</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp_lifecycle</span><span class="o">::</span><span class="n">State</span><span class="w"> </span><span class="o">&amp;</span><span class="n">previous_state</span><span class="p">){</span>
<span class="w">  </span><span class="c1">// Callback function for cleanup transition</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">CallbackReturn</span><span class="o">::</span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">controller_interface</span><span class="o">::</span><span class="n">CallbackReturn</span><span class="w"> </span><span class="nf">on_shutdown</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp_lifecycle</span><span class="o">::</span><span class="n">State</span><span class="w"> </span><span class="o">&amp;</span><span class="n">previous_state</span><span class="p">){</span>
<span class="w">  </span><span class="c1">// Callback function for shutdown transition</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">CallbackReturn</span><span class="o">::</span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">on_error</span></code> method is called if the managed node fails a state transition. This should generally never happen.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">controller_interface</span><span class="o">::</span><span class="n">CallbackReturn</span><span class="w"> </span><span class="nf">on_error</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp_lifecycle</span><span class="o">::</span><span class="n">State</span><span class="w"> </span><span class="o">&amp;</span><span class="n">previous_state</span><span class="p">){</span>
<span class="w">  </span><span class="c1">// Callback function for erroneous transition</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">CallbackReturn</span><span class="o">::</span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="id1">
<h3>Plugin description file<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h3>
<p>The plugin description file is again required for the controller, since it is exported as a library. The controller plugin description file is formatted as follows. See <a class="reference external" href="https://github.com/ros-controls/ros2_control_demos/tree/master/example_7/r6bot_controller/robot_6_dof_controller_plugin_description.xml">here</a> for the complete XML file.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;library</span><span class="w"> </span><span class="na">path=</span><span class="s">&quot;{Library_Name}&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;class</span>
<span class="w">    </span><span class="na">name=</span><span class="s">&quot;{Namespace}/{Class_Name}&quot;</span>
<span class="w">    </span><span class="na">type=</span><span class="s">&quot;{Namespace}::{Class_Name}&quot;</span>
<span class="w">    </span><span class="na">base_class_type=</span><span class="s">&quot;controller_interface::ControllerInterface&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;description&gt;</span>
<span class="w">    </span>{Human<span class="w"> </span>readable<span class="w"> </span>description}
<span class="w">  </span><span class="nt">&lt;/description&gt;</span>
<span class="w">  </span><span class="nt">&lt;/class&gt;</span>
<span class="nt">&lt;/library&gt;</span>
</pre></div>
</div>
</section>
<section id="id2">
<h3>CMake library<a class="headerlink" href="#id2" title="Permalink to this heading"></a></h3>
<p>The plugin must be specified in the CMake file that builds the controller plugin. See <a class="reference external" href="https://github.com/ros-controls/ros2_control_demos/tree/master/example_7/r6bot_controller/CMakeLists.txt">here</a> for the complete <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">add_library</span><span class="p">(</span>
<span class="w">    </span><span class="s">r6bot_controller</span>
<span class="w">    </span><span class="s">SHARED</span>
<span class="w">    </span><span class="s">src/robot_controller.cpp</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="launching-the-example">
<h2>Launching the example<a class="headerlink" href="#launching-the-example" title="Permalink to this heading"></a></h2>
<p>The full tutorial example can be run by first building the workspace.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>-b<span class="w"> </span>master<span class="w"> </span>https://github.com/ros-controls/ros2_control_demos.git
<span class="nb">cd</span><span class="w"> </span>ros2_control_demos
colcon<span class="w"> </span>build<span class="w"> </span>--symlink-install
<span class="nb">source</span><span class="w"> </span>install/setup.bash
</pre></div>
</div>
<p>To view the robot, open a terminal and launch the <code class="docutils literal notranslate"><span class="pre">view_r6bot.launch.py</span></code> file from the <code class="docutils literal notranslate"><span class="pre">ros2_control_demo_example_7</span></code> package.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>ros2<span class="w"> </span>launch<span class="w"> </span>ros2_control_demo_example_7<span class="w"> </span>view_r6bot.launch.py
</pre></div>
</div>
<p>With the <code class="docutils literal notranslate"><span class="pre">joint_state_publisher_gui</span></code> you can now change the position of every joint.</p>
<p>Next, kill the process in the launch file and start the simulation of the controlled robot.
Open a terminal and launch the <code class="docutils literal notranslate"><span class="pre">r6bot_controller.launch.py</span></code> file from the <code class="docutils literal notranslate"><span class="pre">ros2_control_demo_example_7</span></code> package.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>ros2<span class="w"> </span>launch<span class="w"> </span>ros2_control_demo_example_7<span class="w"> </span>r6bot_controller.launch.py
</pre></div>
</div>
<p>Finally, open a new  terminal and run the following command.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>ros2<span class="w"> </span>launch<span class="w"> </span>ros2_control_demo_example_7<span class="w"> </span>send_trajectory.launch.py
</pre></div>
</div>
<p>You should see the tutorial robot making a circular motion in RViz.</p>
<figure class="align-center" id="id9">
<a class="reference internal image-reference" href="../../../../_images/trajectory.gif"><img alt="trajectory" src="../../../../_images/trajectory.gif" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text">Trajectory following example.</span><a class="headerlink" href="#id9" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
</section>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../../example_8/doc/userdoc.html" class="btn btn-neutral float-right" title="Example 8: Industrial Robots with an exposed transmission interface" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../../example_6/doc/userdoc.html" class="btn btn-neutral float-left" title="Example 6: Modular Robots with separate communication to each actuator" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2023, ros2_control Maintainers.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: master
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>ros2_control - Rolling</dt>
      <dd><a href="userdoc.html">Master (latest)</a></dd>
    </dl>
    <dl>
      <dt>ros2_control - Foxy and Galactic</dt>
        <dd><a href="../../../../../galactic/index.html">Galactic (recommended)</a></dd><br>
        <dd><a href="../../../../../foxy/index.html">Foxy</a></dd><br>
    </dl>
  </div>
</div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>